<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDP Panel V1 - Gestionnaire de Photos Discord</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Ic√¥nes simplifi√©es
        const Upload = () => <span>üì§</span>;
        const Image = () => <span>üñºÔ∏è</span>;
        const BarChart3 = () => <span>üìä</span>;
        const Home = () => <span>üè†</span>;
        const Snowflake = () => <span>‚ùÑÔ∏è</span>;
        const Gift = () => <span>üéÅ</span>;

        const PDPPanel = () => {
          const [activeTab, setActiveTab] = useState('home');
          const [christmasMode, setChristmasMode] = useState(true);
          const [pinterestUrl, setPinterestUrl] = useState('');
          const [category, setCategory] = useState('boy');
          const [photoCount, setPhotoCount] = useState(10);
          const [importing, setImporting] = useState(false);
          const [progress, setProgress] = useState(0);
          const [currentMessage, setCurrentMessage] = useState('');
          const [result, setResult] = useState(null);
          const [snowflakes, setSnowflakes] = useState([]);
          const [stats, setStats] = useState(null);
          const [photos, setPhotos] = useState([]);
          const [loading, setLoading] = useState(false);

          const API_URL = 'https://pfpbot-8e9l.onrender.com';
          const API_KEY = 'Nono1912';

          useEffect(() => {
            if (activeTab === 'home' || activeTab === 'stats') {
              fetchStats();
            }
            if (activeTab === 'gallery') {
              fetchPhotos();
            }
          }, [activeTab]);

          const fetchStats = async () => {
            try {
              const response = await fetch(`${API_URL}/api/stats`, {
                headers: { 'X-API-Key': API_KEY }
              });
              if (response.ok) {
                const data = await response.json();
                setStats(data);
              }
            } catch (error) {
              console.error('Erreur stats:', error);
            }
          };

          const fetchPhotos = async (page = 1) => {
            setLoading(true);
            try {
              const response = await fetch(`${API_URL}/api/photos?page=${page}&limit=20`, {
                headers: { 'X-API-Key': API_KEY }
              });
              if (response.ok) {
                const data = await response.json();
                setPhotos(data.photos || []);
              }
            } catch (error) {
              console.error('Erreur photos:', error);
            } finally {
              setLoading(false);
            }
          };

          useEffect(() => {
            if (christmasMode) {
              const flakes = Array.from({ length: 30 }, (_, i) => ({
                id: i,
                left: Math.random() * 100,
                delay: Math.random() * 5,
                duration: 5 + Math.random() * 5,
                size: 10 + Math.random() * 20
              }));
              setSnowflakes(flakes);
            }
          }, [christmasMode]);

          const categories = [
            { value: 'boy', label: 'üë¶ Boy' },
            { value: 'girl', label: 'üëß Girl' },
            { value: 'anime', label: 'üéå Anime' },
            { value: 'aesthetic', label: '‚ú® Aesthetic' },
            { value: 'cute', label: 'ü•∞ Cute' },
            { value: 'banner', label: 'üé® Banner' },
            { value: 'match', label: 'üíï Match' }
          ];

          const handleImport = async () => {
            if (!pinterestUrl.trim()) {
              alert('‚ùå Veuillez entrer un lien Pinterest');
              return;
            }
            if (!pinterestUrl.includes('pinterest.com') && !pinterestUrl.includes('pin.it')) {
              alert('‚ùå Le lien doit √™tre un lien Pinterest valide');
              return;
            }

            setImporting(true);
            setProgress(0);
            setResult(null);
            setCurrentMessage('Initialisation...');

            try {
              const response = await fetch(`${API_URL}/api/pinterest/scrape`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-API-Key': API_KEY
                },
                body: JSON.stringify({
                  pinterest_url: pinterestUrl,
                  category: category,
                  max_photos: photoCount
                })
              });

              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Erreur lors du scraping');
              }

              const reader = response.body.getReader();
              const decoder = new TextDecoder();
              let buffer = '';

              while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                  if (line.startsWith('data: ')) {
                    try {
                      const data = JSON.parse(line.slice(6));
                      
                      if (data.type === 'progress') {
                        setProgress(data.progress);
                        setCurrentMessage(data.message || 'En cours...');
                      } else if (data.type === 'complete') {
                        setProgress(100);
                        setCurrentMessage('Termin√© !');
                        setTimeout(() => {
                          setImporting(false);
                          setResult(data.result);
                          fetchStats();
                        }, 500);
                      } else if (data.type === 'error') {
                        throw new Error(data.message);
                      }
                    } catch (e) {
                      console.error('Parse error:', e);
                    }
                  }
                }
              }
            } catch (error) {
              setImporting(false);
              setProgress(0);
              console.error('Erreur import:', error);
              alert(`‚ùå ${error.message}`);
            }
          };

          const TabButton = ({ name, icon: Icon, label }) => (
            <button
              onClick={() => setActiveTab(name)}
              className={`flex items-center gap-2 px-6 py-3 rounded-xl font-medium transition-all ${
                activeTab === name
                  ? christmasMode
                    ? 'bg-gradient-to-r from-red-500 to-green-500 text-white shadow-lg scale-105'
                    : 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg scale-105'
                  : christmasMode
                  ? 'bg-red-900/20 text-red-100 hover:bg-red-900/30'
                  : 'bg-white/10 text-white hover:bg-white/20'
              }`}
            >
              <Icon />
              <span>{label}</span>
            </button>
          );

          return (
            <div className={`min-h-screen ${
              christmasMode 
                ? 'bg-gradient-to-br from-red-900 via-green-900 to-red-900' 
                : 'bg-gradient-to-br from-purple-900 via-pink-900 to-indigo-900'
            } p-8 relative overflow-hidden`}>
              
              {christmasMode && snowflakes.map(flake => (
                <div
                  key={flake.id}
                  className="absolute text-white opacity-70 pointer-events-none"
                  style={{
                    left: `${flake.left}%`,
                    top: '-20px',
                    animation: `fall ${flake.duration}s linear infinite`,
                    animationDelay: `${flake.delay}s`,
                    fontSize: `${flake.size}px`
                  }}
                >
                  ‚ùÑÔ∏è
                </div>
              ))}

              <style>{`
                @keyframes fall {
                  to { transform: translateY(100vh); }
                }
                @keyframes shimmer {
                  0% { transform: translateX(-100%); }
                  100% { transform: translateX(100%); }
                }
              `}</style>

              <div className="max-w-7xl mx-auto mb-8">
                <div className="flex items-center justify-between flex-wrap gap-4">
                  <div>
                    <h1 className="text-4xl md:text-5xl font-bold text-white mb-2 flex items-center gap-3 flex-wrap">
                      {christmasMode ? 'üéÖ' : 'üì∏'}
                      {christmasMode && <span className="animate-spin">‚ùÑÔ∏è</span>}
                      <span>PDP Panel V1</span>
                      {christmasMode && <span className="animate-bounce">üéÅ</span>}
                    </h1>
                    <p className="text-white/70 text-base md:text-lg">
                      {christmasMode ? 'üéÑ Joyeux No√´l ! Panel d\'administration' : 'Panel d\'administration du bot Discord'}
                    </p>
                  </div>
                  
                  <button
                    onClick={() => setChristmasMode(!christmasMode)}
                    className={`px-4 py-2 rounded-xl font-medium transition-all ${
                      christmasMode
                        ? 'bg-red-600 hover:bg-red-700 text-white'
                        : 'bg-purple-600 hover:bg-purple-700 text-white'
                    }`}
                  >
                    {christmasMode ? 'üéÑ Mode No√´l' : '‚ú® Mode Normal'}
                  </button>
                </div>
              </div>

              <div className="max-w-7xl mx-auto mb-8 flex gap-4 flex-wrap">
                <TabButton name="home" icon={Home} label="Accueil" />
                <TabButton name="import" icon={Upload} label="Import Pinterest" />
                <TabButton name="gallery" icon={Image} label="Galerie" />
                <TabButton name="stats" icon={BarChart3} label="Stats" />
              </div>

              <div className="max-w-7xl mx-auto">
                {activeTab === 'import' && (
                  <div className="space-y-6">
                    <h2 className="text-2xl md:text-3xl font-bold text-white mb-6">
                      {christmasMode ? 'üéÅ Importer des Photos depuis Pinterest' : 'üì∏ Importer des Photos depuis Pinterest'}
                    </h2>

                    <div className="bg-blue-500/20 border border-blue-400/30 rounded-xl p-4 backdrop-blur-lg">
                      <h3 className="text-white font-semibold mb-2">üí° Exemples de liens Pinterest valides :</h3>
                      <div className="text-sm text-white/80 space-y-1">
                        <div>‚Ä¢ Page de recherche : <code className="bg-black/30 px-2 py-1 rounded">https://fr.pinterest.com/search/pins/?q=pfp+boy</code></div>
                        <div>‚Ä¢ Tableau : <code className="bg-black/30 px-2 py-1 rounded">https://fr.pinterest.com/username/board-name/</code></div>
                      </div>
                    </div>

                    <div>
                      <label className="block text-white font-medium mb-2">Lien Pinterest</label>
                      <input
                        type="url"
                        value={pinterestUrl}
                        onChange={(e) => setPinterestUrl(e.target.value)}
                        placeholder="https://fr.pinterest.com/search/pins/?q=pfp%20boy%20discord"
                        className="w-full px-4 py-3 rounded-xl bg-white/20 border border-white/30 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
                        disabled={importing}
                      />
                    </div>

                    <div>
                      <label className="block text-white font-medium mb-3">Cat√©gorie</label>
                      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-3">
                        {categories.map(cat => (
                          <button
                            key={cat.value}
                            onClick={() => setCategory(cat.value)}
                            disabled={importing}
                            className={`px-4 py-3 rounded-xl font-medium transition-all disabled:opacity-50 ${
                              category === cat.value
                                ? christmasMode
                                  ? 'bg-gradient-to-r from-red-500 to-green-500 text-white shadow-lg scale-105'
                                  : 'bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg scale-105'
                                : 'bg-white/10 text-white hover:bg-white/20'
                            }`}
                          >
                            {cat.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    <div>
                      <label className="block text-white font-medium mb-3">
                        Nombre de photos maximum : {photoCount}
                      </label>
                      <input
                        type="range"
                        min="1"
                        max="100"
                        value={photoCount}
                        onChange={(e) => setPhotoCount(parseInt(e.target.value))}
                        disabled={importing}
                        className="w-full h-2 rounded-lg appearance-none cursor-pointer"
                      />
                    </div>

                    <button
                      onClick={handleImport}
                      disabled={importing || !pinterestUrl.trim()}
                      className={`relative w-full px-8 py-6 rounded-2xl font-bold text-xl transition-all shadow-2xl disabled:opacity-50 overflow-hidden group ${
                        christmasMode
                          ? 'bg-gradient-to-r from-red-600 via-yellow-500 to-green-600'
                          : 'bg-gradient-to-r from-purple-600 via-pink-500 to-indigo-600'
                      } text-white hover:scale-105`}
                    >
                      <div className="absolute -top-3 -right-3 bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-black rotate-12">
                        ‚≠ê VIP
                      </div>
                      
                      <span className="relative z-10 flex items-center justify-center gap-3">
                        {importing ? (
                          <>
                            <span className="animate-spin">‚è≥</span>
                            Import en cours...
                          </>
                        ) : (
                          <>
                            <span className="animate-bounce">üéÖ</span>
                            D√©marrer le Scraping Pinterest
                            <span className="animate-bounce">‚ú®</span>
                          </>
                        )}
                      </span>
                    </button>

                    {importing && (
                      <div className="space-y-2">
                        <div className="w-full bg-white/20 rounded-full h-4 overflow-hidden">
                          <div
                            className={`h-full transition-all ${
                              christmasMode
                                ? 'bg-gradient-to-r from-red-500 to-green-500'
                                : 'bg-gradient-to-r from-purple-500 to-pink-500'
                            }`}
                            style={{ width: `${progress}%` }}
                          />
                        </div>
                        <div className="flex items-center justify-between text-white font-medium">
                          <span>{progress}%</span>
                          <span className="text-sm">{currentMessage}</span>
                        </div>
                      </div>
                    )}

                    {result && (
                      <div className="rounded-2xl p-8 backdrop-blur-lg border-2 bg-gradient-to-br from-green-900/40 to-red-900/40 border-green-500/30">
                        <div className="text-center mb-6">
                          <div className="text-6xl mb-3 animate-bounce">üéÅ</div>
                          <h3 className="text-2xl font-bold text-white mb-2">Import termin√© !</h3>
                        </div>
                        
                        <div className="grid grid-cols-3 gap-4">
                          <div className="text-center p-4 bg-white/10 rounded-xl">
                            <div className="text-3xl font-bold text-blue-400">{result.detected}</div>
                            <div className="text-sm text-white/70">D√©tect√©es</div>
                          </div>
                          <div className="text-center p-4 bg-white/10 rounded-xl">
                            <div className="text-3xl font-bold text-green-400">{result.inserted}</div>
                            <div className="text-sm text-white/70">Ins√©r√©es</div>
                          </div>
                          <div className="text-center p-4 bg-white/10 rounded-xl">
                            <div className="text-3xl font-bold text-orange-400">{result.duplicates}</div>
                            <div className="text-sm text-white/70">Doublons</div>
                          </div>
                        </div>

                        <div className="mt-4 p-4 bg-blue-500/20 rounded-xl">
                          <div className="text-sm text-white/90">
                            üì§ {result.inserted} photos envoy√©es vers Discord !
                          </div>
                        </div>

                        <button
                          onClick={() => {
                            setResult(null);
                            setPinterestUrl('');
                          }}
                          className="w-full mt-6 px-6 py-3 rounded-xl bg-white/10 hover:bg-white/20 text-white font-medium"
                        >
                          Nouvel import
                        </button>
                      </div>
                    )}
                  </div>
                )}

                {activeTab === 'home' && (
                  <div className="space-y-8">
                    <div className="relative overflow-hidden rounded-2xl bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-lg border border-white/20 p-8">
                      <h2 className="text-4xl font-bold text-white mb-3">
                        {christmasMode ? 'üéÑ Bienvenue !' : 'üëã Bienvenue !'}
                      </h2>
                      <p className="text-white/70 text-lg">
                        G√©rez vos photos de profil Discord en toute simplicit√©
                      </p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div className="bg-gradient-to-br from-blue-500/20 to-blue-600/10 backdrop-blur-lg border border-blue-400/30 rounded-xl p-6">
                        <div className="text-3xl font-bold text-white">{stats ? stats.total_photos?.toLocaleString() : '...'}</div>
                        <div className="text-sm text-white/70">Photos totales</div>
                      </div>
                      <div className="bg-gradient-to-br from-green-500/20 to-green-600/10 backdrop-blur-lg border border-green-400/30 rounded-xl p-6">
                        <div className="text-3xl font-bold text-white">{stats ? stats.recent_imports : '...'}</div>
                        <div className="text-sm text-white/70">Imports ce mois</div>
                      </div>
                      <div className="bg-gradient-to-br from-purple-500/20 to-purple-600/10 backdrop-blur-lg border border-purple-400/30 rounded-xl p-6">
                        <div className="text-3xl font-bold text-white">{stats ? stats.categories?.length : '...'}</div>
                        <div className="text-sm text-white/70">Cat√©gories</div>
                      </div>
                      <div className="bg-gradient-to-br from-orange-500/20 to-orange-600/10 backdrop-blur-lg border border-orange-400/30 rounded-xl p-6">
                        <div className="text-3xl font-bold text-white">{stats ? stats.available_photos?.toLocaleString() : '...'}</div>
                        <div className="text-sm text-white/70">Sur Discord</div>
                      </div>
                    </div>

                    <div>
                      <h3 className="text-xl font-semibold text-white mb-4">Actions rapides</h3>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button
                          onClick={() => setActiveTab('import')}
                          className="group relative overflow-hidden bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-lg border border-white/20 rounded-xl p-6 hover:border-white/40 transition-all text-left"
                        >
                          <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-500 rounded-lg flex items-center justify-center mb-4 group-hover:scale-110 transition-transform text-2xl">
                            üì§
                          </div>
                          <h4 className="text-lg font-semibold text-white mb-2">Importer des photos</h4>
                          <p className="text-sm text-white/60">Ajoutez de nouvelles photos depuis Pinterest</p>
                        </button>

                        <button
                          onClick={() => setActiveTab('gallery')}
                          className="group relative overflow-hidden bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-lg border border-white/20 rounded-xl p-6 hover:border-white/40 transition-all text-left"
                        >
                          <div className="w-12 h-12 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg flex items-center justify-center mb-4 group-hover:scale-110 transition-transform text-2xl">
                            üñºÔ∏è
                          </div>
                          <h4 className="text-lg font-semibold text-white mb-2">G√©rer la galerie</h4>
                          <p className="text-sm text-white/60">Parcourez et organisez vos photos</p>
                        </button>

                        <button
                          onClick={() => setActiveTab('stats')}
                          className="group relative overflow-hidden bg-gradient-to-br from-white/10 to-white/5 backdrop-blur-lg border border-white/20 rounded-xl p-6 hover:border-white/40 transition-all text-left"
                        >
                          <div className="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-500 rounded-lg flex items-center justify-center mb-4 group-hover:scale-110 transition-transform text-2xl">
                            üìä
                          </div>
                          <h4 className="text-lg font-semibold text-white mb-2">Voir les statistiques</h4>
                          <p className="text-sm text-white/60">Analysez vos performances</p>
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'gallery' && (
                  <div className="space-y-6">
                    <h2 className="text-3xl font-bold text-white mb-2">Galerie</h2>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                      {loading ? (
                        <div className="col-span-full text-center text-white py-12">
                          <div className="animate-spin text-4xl mb-4">‚è≥</div>
                          <div>Chargement...</div>
                        </div>
                      ) : photos.length > 0 ? (
                        photos.map((photo) => (
                          <div
                            key={photo.id}
                            className="aspect-square bg-white/10 rounded-xl overflow-hidden hover:scale-105 transition-transform"
                          >
                            <img 
                              src={photo.url} 
                              alt={photo.category}
                              className="w-full h-full object-cover"
                            />
                          </div>
                        ))
                      ) : (
                        <div className="col-span-full text-center text-white/70 py-12">
                          Aucune photo. Importez depuis Pinterest !
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {activeTab === 'stats' && (
                  <div className="space-y-6">
                    <h2 className="text-3xl font-bold text-white mb-2">Statistiques</h2>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6">
                        <div className="text-4xl font-bold text-white mb-2">
                          {stats ? stats.total_photos?.toLocaleString() : '0'}
                        </div>
                        <div className="text-sm text-white/70">Photos totales</div>
                      </div>
                      <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6">
                        <div className="text-4xl font-bold text-white mb-2">
                          {stats ? stats.recent_imports : '0'}
                        </div>
                        <div className="text-sm text-white/70">Imports ce mois</div>
                      </div>
                      <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6">
                        <div className="text-4xl font-bold text-white mb-2">
                          {stats ? stats.categories?.length : '0'}
                        </div>
                        <div className="text-sm text-white/70">Cat√©gories actives</div>
                      </div>
                      <div className="bg-white/10 backdrop-blur-lg rounded-xl p-6">
                        <div className="text-4xl font-bold text-white mb-2">
                          {stats ? stats.success_rate : '0'}%
                        </div>
                        <div className="text-sm text-white/70">Taux de succ√®s</div>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      <div className="bg-white/10 backdrop-blur-lg border border-white/20 rounded-xl p-6">
                        <h3 className="text-xl font-semibold text-white mb-6">Photos par cat√©gorie</h3>
                        <div className="space-y-4">
                          {categories.map((cat, i) => {
                            const catStats = stats?.categories?.find(c => c.category === cat.value);
                            const count = catStats?.count || 0;
                            const total = stats?.total_photos || 1;
                            const percentage = Math.round((count / total) * 100);
                            
                            return (
                              <div key={i}>
                                <div className="flex items-center justify-between text-sm text-white/70 mb-2">
                                  <span>{cat.label}</span>
                                  <span className="font-medium text-white">{count} photos</span>
                                </div>
                                <div className="w-full bg-white/10 rounded-full h-3">
                                  <div
                                    className="bg-gradient-to-r from-red-500 to-green-500 h-3 rounded-full transition-all duration-1000"
                                    style={{ width: `${percentage}%` }}
                                  ></div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>

                      <div className="bg-white/10 backdrop-blur-lg border border-white/20 rounded-xl p-6">
                        <h3 className="text-xl font-semibold text-white mb-6">Performance</h3>
                        <div className="space-y-4">
                          <div className="text-center p-4 bg-white/5 rounded-xl">
                            <div className="text-3xl mb-2">‚ö°</div>
                            <div className="text-2xl font-bold text-white mb-1">Rapide</div>
                            <div className="text-sm text-white/70">Temps de r√©ponse</div>
                          </div>
                          <div className="text-center p-4 bg-white/5 rounded-xl">
                            <div className="text-3xl mb-2">‚úÖ</div>
                            <div className="text-2xl font-bold text-white mb-1">99.8%</div>
                            <div className="text-sm text-white/70">Taux de succ√®s</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        ReactDOM.render(<PDPPanel />, document.getElementById('root'));
    </script>
</body>
</html>
