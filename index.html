<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PDP Panel V1</title>
<style>
  :root{
    --bg1:#0b1020;
    --bg2:#071427;
    --card:#0f1728;
    --muted:#000;
    --accent:#7c3aed;
  }
  *{
    box-sizing:border-box;
    margin:0;
    padding:0;
  }
  body{
    font-family:system-ui,-apple-system,sans-serif;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 25%,#f093fb 50%,#4facfe 75%,#00f2fe 100%);
    background-size:400% 400%;
    animation:gradient 15s ease infinite;
    color:#000;
    min-height:100vh;
    padding:2rem;
  }
  @keyframes gradient{
    0%{background-position:0% 50%}
    50%{background-position:100% 50%}
    100%{background-position:0% 50%}
  }
  .container{
    max-width:1400px;
    margin:0 auto;
  }
  header{
    background:rgba(255,255,255,0.08);
    backdrop-filter:blur(20px);
    border-radius:16px;
    padding:1.5rem 2rem;
    margin-bottom:2rem;
    border:1px solid rgba(255,255,255,0.15);
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  nav{
    display:flex;
    gap:1rem;
    margin-bottom:2rem;
    background:rgba(255,255,255,0.08);
    backdrop-filter:blur(20px);
    padding:1rem;
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.15);
    flex-wrap:wrap;
  }
  .nav-btn{
    padding:0.75rem 1.5rem;
    background:transparent;
    color:#000;
    border:none;
    border-radius:12px;
    cursor:pointer;
    font-size:1rem;
    font-weight:500;
    transition:all 0.3s ease;
  }
  .nav-btn:hover{
    background:rgba(255,255,255,0.1);
  }
  .nav-btn.active{
    background:var(--accent);
    color:#fff;
    box-shadow:0 4px 20px rgba(124,58,237,0.4);
  }
  .card{
    background:rgba(255,255,255,0.08);
    backdrop-filter:blur(20px);
    border-radius:16px;
    padding:2rem;
    border:1px solid rgba(255,255,255,0.15);
    margin-bottom:2rem;
  }
  .view{
    display:none;
  }
  .view.active{
    display:block;
  }
  .form-group{
    margin-bottom:1.5rem;
  }
  .form-group label{
    display:block;
    margin-bottom:0.5rem;
    font-weight:500;
    color:#000;
  }
  .form-group input{
    width:100%;
    padding:0.875rem;
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:8px;
    color:#000;
    font-size:1rem;
  }
  .form-group select{
    width:100%;
    padding:0.875rem;
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:8px;
    color:#000;
    font-size:1rem;
    cursor:pointer;
  }
  .form-group select:focus,
  .form-group input:focus{
    outline:none;
    border-color:var(--accent);
  }
  .range-container{
    display:flex;
    align-items:center;
    gap:1rem;
  }
  .range-container input[type="range"]{
    flex:1;
    height:8px;
    background:rgba(255,255,255,0.1);
    border-radius:8px;
    outline:none;
    -webkit-appearance:none;
  }
  .range-container input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    appearance:none;
    width:20px;
    height:20px;
    background:var(--accent);
    cursor:pointer;
    border-radius:50%;
    box-shadow:0 2px 8px rgba(124,58,237,0.4);
  }
  .range-container input[type="range"]::-moz-range-thumb{
    width:20px;
    height:20px;
    background:var(--accent);
    cursor:pointer;
    border-radius:50%;
    border:none;
    box-shadow:0 2px 8px rgba(124,58,237,0.4);
  }
  .range-value{
    min-width:60px;
    padding:0.5rem 1rem;
    background:rgba(124,58,237,0.2);
    border:1px solid var(--accent);
    border-radius:8px;
    text-align:center;
    font-weight:600;
    color:#000;
  }
  button[type="submit"]{
    padding:1rem 2rem;
    background:linear-gradient(135deg,var(--accent),#3b82f6);
    color:#fff;
    border:none;
    border-radius:8px;
    font-size:1rem;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s ease;
  }
  button[type="submit"]:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 25px rgba(124,58,237,0.4);
  }
  .stats-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:1.5rem;
    margin-top:2rem;
  }
  .stat-card{
    padding:1.5rem;
    background:rgba(255,255,255,0.05);
    border-radius:12px;
    border:1px solid rgba(255,255,255,0.1);
  }
  .stat-value{
    font-size:2rem;
    font-weight:700;
    margin-bottom:0.5rem;
    color:#000;
  }
  .stat-label{
    color:#000;
    font-size:0.875rem;
  }
  .log-container{
    background:rgba(0,0,0,0.3);
    border-radius:8px;
    padding:1rem;
    max-height:400px;
    overflow-y:auto;
    font-family:monospace;
    font-size:0.875rem;
  }
  .log-entry{
    padding:0.5rem;
    margin-bottom:0.5rem;
    border-radius:4px;
    border-left:3px solid #10b981;
  }
  .log-entry.error{
    border-left-color:#ef4444;
  }
  .pulse{
    animation:pulse 2s cubic-bezier(0.4,0,0.6,1) infinite
  }
  @keyframes pulse{
    0%,100%{opacity:1}
    50%{opacity:0.5}
  }
  .category-card{
    padding:2rem;
    background:rgba(255,255,255,0.06);
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.15);
    cursor:pointer;
    transition:all 0.3s ease;
    position:relative;
    overflow:hidden
  }
  .category-card:hover{
    background:rgba(255,255,255,0.1);
    border-color:var(--accent);
    transform:translateY(-4px);
    box-shadow:0 12px 40px rgba(124,58,237,0.3)
  }
  .category-icon{
    font-size:3rem;
    margin-bottom:1rem;
    display:inline-block;
    transition:transform 0.3s ease
  }
  .category-card:hover .category-icon{
    transform:scale(1.1) rotate(5deg)
  }
  .category-card h3{
    margin:0 0 0.5rem;
    font-size:1.5rem;
    font-weight:700;
    color:#000;
  }
  .category-card p{
    color:#000;
    margin:0 0 1rem;
    line-height:1.6
  }
  .category-badge{
    display:inline-block;
    padding:0.375rem 0.875rem;
    background:linear-gradient(135deg,var(--accent),#3b82f6);
    border-radius:20px;
    font-size:0.75rem;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.05em
  }
  #loginScreen{
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:100vh;
  }
  .login-card{
    background:rgba(255,255,255,0.1);
    backdrop-filter:blur(20px);
    border-radius:24px;
    padding:3rem;
    border:1px solid rgba(255,255,255,0.2);
    text-align:center;
    max-width:400px;
    width:100%;
  }
  .login-card h1{
    font-size:2.5rem;
    margin-bottom:0.5rem;
    color:#000;
  }
  .login-card p{
    color:#000;
    margin-bottom:2rem;
  }
  .discord-btn{
    display:flex;
    align-items:center;
    justify-content:center;
    gap:0.75rem;
    width:100%;
    padding:1rem 2rem;
    background:#5865F2;
    color:#fff;
    border:none;
    border-radius:8px;
    font-size:1.125rem;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s ease;
  }
  .discord-btn:hover{
    background:#4752C4;
    transform:translateY(-2px);
    box-shadow:0 8px 25px rgba(88,101,242,0.4);
  }
  
  /* TOAST NOTIFICATIONS */
  .toast-container{
    position:fixed;
    top:2rem;
    right:2rem;
    z-index:9999;
    display:flex;
    flex-direction:column;
    gap:1rem;
  }
  .toast{
    background:rgba(255,255,255,0.95);
    backdrop-filter:blur(20px);
    border-radius:12px;
    padding:1rem 1.5rem;
    box-shadow:0 8px 32px rgba(0,0,0,0.2);
    border-left:4px solid;
    min-width:300px;
    animation:slideIn 0.3s ease;
    display:flex;
    align-items:center;
    gap:0.75rem;
  }
  .toast.success{border-left-color:#10b981}
  .toast.error{border-left-color:#ef4444}
  .toast.info{border-left-color:#3b82f6}
  .toast-icon{font-size:1.5rem}
  .toast-message{flex:1;color:#1f2937;font-weight:500}
  @keyframes slideIn{
    from{transform:translateX(400px);opacity:0}
    to{transform:translateX(0);opacity:1}
  }
  
  /* GALLERY */
  .gallery-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
    gap:1rem;
    margin-top:2rem;
  }
  .gallery-item{
    aspect-ratio:1;
    border-radius:12px;
    overflow:hidden;
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.1);
    cursor:pointer;
    transition:all 0.3s ease;
  }
  .gallery-item:hover{
    transform:scale(1.05);
    box-shadow:0 8px 25px rgba(124,58,237,0.4);
  }
  .gallery-item img{
    width:100%;
    height:100%;
    object-fit:cover;
  }
  .gallery-empty{
    text-align:center;
    padding:3rem;
    color:#000;
    opacity:0.6;
  }
  
  /* PROGRESS BAR */
  .progress-container{
    margin-top:2rem;
  }
  .progress-bar-bg{
    background:rgba(124,58,237,0.2);
    border-radius:8px;
    height:12px;
    overflow:hidden;
  }
  .progress-bar{
    background:linear-gradient(90deg,var(--accent),#3b82f6);
    height:100%;
    width:0%;
    transition:width 0.3s ease;
    border-radius:8px;
  }
  .progress-text{
    margin-top:1rem;
    color:#000;
    text-align:center;
    font-weight:500;
  }
  .progress-stats{
    display:flex;
    justify-content:space-between;
    margin-top:0.5rem;
    font-size:0.875rem;
    color:#000;
  }
  
  /* HISTORY TABLE */
  .history-table{
    width:100%;
    margin-top:2rem;
    border-collapse:collapse;
  }
  .history-table th{
    background:rgba(124,58,237,0.2);
    padding:1rem;
    text-align:left;
    color:#000;
    font-weight:600;
    border-bottom:2px solid rgba(124,58,237,0.4);
  }
  .history-table td{
    padding:1rem;
    border-bottom:1px solid rgba(255,255,255,0.1);
    color:#000;
  }
  .history-table tr:hover{
    background:rgba(255,255,255,0.05);
  }
  .status-badge{
    display:inline-block;
    padding:0.25rem 0.75rem;
    border-radius:12px;
    font-size:0.75rem;
    font-weight:600;
  }
  .status-success{
    background:rgba(16,185,129,0.2);
    color:#10b981;
    border:1px solid #10b981;
  }
  .status-error{
    background:rgba(239,68,68,0.2);
    color:#ef4444;
    border:1px solid #ef4444;
  }
  .status-pending{
    background:rgba(59,130,246,0.2);
    color:#3b82f6;
    border:1px solid #3b82f6;
  }
  
  /* LOADING SPINNER */
  .spinner{
    border:3px solid rgba(255,255,255,0.1);
    border-top:3px solid var(--accent);
    border-radius:50%;
    width:40px;
    height:40px;
    animation:spin 1s linear infinite;
    margin:2rem auto;
  }
  @keyframes spin{
    0%{transform:rotate(0deg)}
    100%{transform:rotate(360deg)}
  }
</style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>

  <div id="loginScreen">
    <div class="login-card">
      <h1>ü§ñ</h1>
      <h1>PDP Panel V1</h1>
      <p>Connectez-vous avec Discord pour acc√©der au panel d'administration</p>
      <button class="discord-btn" onclick="loginWithDiscord()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
        </svg>
        Se connecter avec Discord
      </button>
    </div>
  </div>

  <div id="mainApp" style="display:none">
    <div class="container">
      <header>
        <div style="display:flex;align-items:center;gap:1rem">
          <div style="font-size:2rem">ü§ñ</div>
          <div>
            <h1 style="margin:0;font-size:1.75rem;font-weight:700;color:#000">PDP Panel V1</h1>
            <p style="margin:0.25rem 0 0;color:#000;font-size:0.875rem">Panel d'administration du bot Discord</p>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:1.5rem">
          <div id="botStatusMini" style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background:rgba(124,58,237,0.1);border-radius:8px;border:1px solid rgba(124,58,237,0.3)">
            <div class="pulse" style="width:8px;height:8px;background:#10b981;border-radius:50%"></div>
            <span style="color:#000;font-size:0.875rem">Bot: <span id="statusTextMini">En ligne</span></span>
          </div>
          <div id="userInfo" style="display:none;align-items:center;gap:1rem">
            <img id="userAvatar" style="width:40px;height:40px;border-radius:50%;border:2px solid var(--accent)">
            <span id="userName" style="color:#000"></span>
            <button onclick="logout()" style="padding:0.5rem 1rem;background:rgba(124,58,237,0.2);color:var(--accent);border:1px solid var(--accent);border-radius:8px;cursor:pointer;font-weight:500">
              D√©connexion
            </button>
          </div>
        </div>
      </header>

      <nav>
        <button class="nav-btn active" data-view="home">üè† Accueil</button>
        <button class="nav-btn" data-view="import">üì• Importer</button>
        <button class="nav-btn" data-view="gallery">üñºÔ∏è Galerie</button>
        <button class="nav-btn" data-view="history">üìã Historique</button>
        <button class="nav-btn" data-view="dashboard">üìä Dashboard</button>
        <button class="nav-btn" data-view="logs">üìù Logs</button>
      </nav>

      <div id="homeView" class="view active">
        <div class="card">
          <h2 style="display:flex;align-items:center;gap:0.75rem;margin-bottom:2rem;color:#000">
            <span>üè†</span>
            Cat√©gories
          </h2>
          
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem">
            <div class="category-card" onclick="switchView('import')">
              <div class="category-icon">üì•</div>
              <h3>Importer</h3>
              <p>Scraper et importer des photos de profil depuis Pinterest</p>
              <div class="category-badge">Scraping</div>
            </div>

            <div class="category-card" onclick="switchView('gallery')">
              <div class="category-icon">üñºÔ∏è</div>
              <h3>Galerie</h3>
              <p>Visualiser toutes les photos import√©es en grille</p>
              <div class="category-badge">Preview</div>
            </div>

            <div class="category-card" onclick="switchView('history')">
              <div class="category-icon">üìã</div>
              <h3>Historique</h3>
              <p>Consulter l'historique complet des imports</p>
              <div class="category-badge">Tra√ßabilit√©</div>
            </div>

            <div class="category-card" onclick="switchView('dashboard')">
              <div class="category-icon">üìä</div>
              <h3>Dashboard</h3>
              <p>Statistiques et √©tat du syst√®me en temps r√©el</p>
              <div class="category-badge">Stats</div>
            </div>
          </div>
        </div>
      </div>

      <div id="importView" class="view">
        <div class="card">
          <h2 style="display:flex;align-items:center;gap:0.75rem;color:#000">
            <span>üì•</span>
            Importer des Photos
          </h2>
          <form id="importForm" style="margin-top:2rem">
            <div class="form-group">
              <label>Lien Pinterest</label>
              <input type="url" id="pinterestLink" placeholder="https://pinterest.com/..." required>
            </div>
            <div class="form-group">
              <label>Cat√©gorie</label>
              <select id="category" required>
                <option value="">S√©lectionner une cat√©gorie</option>
                <option value="boy">üë¶ Boy</option>
                <option value="girl">üëß Girl</option>
                <option value="banner">üé® Banner</option>
                <option value="match">üíë Match</option>
              </select>
            </div>
            <div class="form-group">
              <label>Nombre de photos : <span id="photoCountValue" class="range-value">500</span></label>
              <div class="range-container">
                <input type="range" id="photoCount" min="10" max="1000" value="500" step="10" oninput="document.getElementById('photoCountValue').textContent = this.value">
              </div>
            </div>
            <button type="submit">D√©marrer l'import</button>
          </form>
          <div id="importProgress" style="display:none" class="progress-container">
            <div class="progress-bar-bg">
              <div id="progressBar" class="progress-bar"></div>
            </div>
            <p id="progressText" class="progress-text"></p>
            <div class="progress-stats">
              <span>‚è±Ô∏è <span id="timeElapsed">0s</span></span>
              <span>üì∏ <span id="photosScraped">0</span>/<span id="photosTotal">0</span></span>
              <span>‚ö° <span id="speed">0</span> photos/s</span>
            </div>
          </div>
        </div>
      </div>

      <div id="galleryView" class="view">
        <div class="card">
          <h2 style="display:flex;align-items:center;gap:0.75rem;color:#000">
            <span>üñºÔ∏è</span>
            Galerie Photos
          </h2>
          <div style="display:flex;gap:1rem;margin-top:1rem;flex-wrap:wrap">
            <select id="galleryFilter" style="padding:0.5rem 1rem;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#000">
              <option value="all">Toutes cat√©gories</option>
              <option value="boy">üë¶ Boy</option>
              <option value="girl">üëß Girl</option>
              <option value="banner">üé® Banner</option>
              <option value="pdp">üñºÔ∏è PDP</option>
              <option value="match">üíë Match</option>
            </select>
            <button onclick="loadGallery()" style="padding:0.5rem 1.5rem;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer">üîÑ Rafra√Æchir</button>
          </div>
          <div id="galleryGrid" class="gallery-grid"></div>
        </div>
      </div>

      <div id="historyView" class="view">
        <div class="card">
          <h2 style="display:flex;align-items:center;gap:0.75rem;color:#000">
            <span>üìã</span>
            Historique des Imports
          </h2>
          <table class="history-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Source</th>
                <th>Cat√©gorie</th>
                <th>Photos</th>
                <th>Dur√©e</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              <tr><td colspan="6" style="text-align:center;padding:2rem;opacity:0.6">Chargement...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="dashboardView" class="view">
        <div class="card">
          <h2 style="display:flex;align-items:center;gap:0.75rem;color:#000">
            <span>üìä</span>
            Dashboard
          </h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="totalPhotos">0</div>
              <div class="stat-label">Photos scrap√©es</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalImports">0</div>
              <div class="stat-label">Imports r√©alis√©s</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="todayPhotos">0</div>
              <div class="stat-label">Photos aujourd'hui</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="lastActivity">Jamais</div>
              <div class="stat-label">Derni√®re activit√©</div>
            </div>
          </div>
        </div>
      </div>

      <div id="logsView" class="view">
        <div class="card">
          <h2 style="display:flex;align-items:center;gap:0.75rem;color:#000">
            <span>üìù</span>
            Logs Syst√®me
          </h2>
          <div class="log-container" id="logContainer"></div>
        </div>
      </div>
    </div>
  </div>

<script>
    const API_URL = "https://pfpbot-8e9l.onrender.com";
    const DISCORD_CLIENT_ID = "1444812896495206592";
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    let ws = null;
    let importStartTime = null;
    let currentImportId = null;

    function loginWithDiscord() {
      const scope = 'identify guilds.join';
      const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(scope)}`;
      window.location.href = authUrl;
    }

    function logout() {
      localStorage.removeItem('discord_token');
      localStorage.removeItem('discord_user');
      location.reload();
    }

    async function fetchDiscordUser(token) {
      const response = await fetch('https://discord.com/api/users/@me', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      return response.json();
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è'
      };
      
      toast.innerHTML = `
        <div class="toast-icon">${icons[type]}</div>
        <div class="toast-message">${message}</div>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    function connectWebSocket() {
      const wsUrl = API_URL.replace('https', 'wss').replace('http', 'ws');
      ws = new WebSocket(`${wsUrl}/ws`);
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        if (data.type === 'progress') {
          updateProgress(data);
        } else if (data.type === 'complete') {
          showToast(`Import termin√© ! ${data.total} photos scrap√©es`, 'success');
          document.getElementById('progressBar').style.width = '100%';
          document.getElementById('progressText').textContent = `‚úÖ Import termin√© avec succ√®s`;
          loadGallery();
          loadHistory();
          updateDashboard();
        } else if (data.type === 'error') {
          showToast(`Erreur: ${data.message}`, 'error');
        }
      };
      
      ws.onerror = () => {
        addLog('WebSocket: Erreur de connexion', 'error');
      };
    }

    function updateProgress(data) {
      const { current, total, speed } = data;
      const percent = Math.round((current / total) * 100);
      const elapsed = Math.round((Date.now() - importStartTime) / 1000);
      
      document.getElementById('progressBar').style.width = `${percent}%`;
      document.getElementById('progressText').textContent = `Scraping en cours... ${percent}%`;
      document.getElementById('photosScraped').textContent = current;
      document.getElementById('photosTotal').textContent = total;
      document.getElementById('timeElapsed').textContent = `${elapsed}s`;
      document.getElementById('speed').textContent = speed || 0;
    }

    window.addEventListener('load', async () => {
      const fragment = window.location.hash.substr(1);
      const params = new URLSearchParams(fragment);
      const token = params.get('access_token');

      if (token) {
        localStorage.setItem('discord_token', token);
        const user = await fetchDiscordUser(token);
        localStorage.setItem('discord_user', JSON.stringify(user));
        window.location.hash = '';
        window.location.reload();
        return;
      }

      const savedToken = localStorage.getItem('discord_token');
      const savedUser = localStorage.getItem('discord_user');

      if (savedToken && savedUser) {
        const user = JSON.parse(savedUser);
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userInfo').style.display = 'flex';
        document.getElementById('userName').textContent = user.username;
        document.getElementById('userAvatar').src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
      } else {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
      }
      
      checkBotStatus();
      setInterval(checkBotStatus, 30000);
      connectWebSocket();
    });

    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchView(btn.dataset.view);
      });
    });

    function switchView(viewName) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(viewName + 'View').classList.add('active');
      document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
      
      if (viewName === 'dashboard') {
        updateDashboard();
      } else if (viewName === 'gallery') {
        loadGallery();
      } else if (viewName === 'history') {
        loadHistory();
      }
    }

    async function checkBotStatus() {
      try {
        const response = await fetch(`${API_URL}/status`);
        const data = await response.json();
        const statusMiniEl = document.getElementById('botStatusMini');
        const statusTextMiniEl = document.getElementById('statusTextMini');
        
        if (data.status === 'online') {
          statusMiniEl.querySelector('.pulse').style.background = '#10b981';
          statusTextMiniEl.textContent = 'En ligne';
        } else {
          statusMiniEl.querySelector('.pulse').style.background = '#ef4444';
          statusTextMiniEl.textContent = 'Hors ligne';
        }
      } catch (error) {
        const statusMiniEl = document.getElementById('botStatusMini');
        const statusTextMiniEl = document.getElementById('statusTextMini');
        statusMiniEl.querySelector('.pulse').style.background = '#ef4444';
        statusTextMiniEl.textContent = 'Hors ligne';
      }
    }

    document.getElementById('importForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const pinterestLink = document.getElementById('pinterestLink').value;
      const category = document.getElementById('category').value;
      const photoCount = document.getElementById('photoCount').value;
      const progressDiv = document.getElementById('importProgress');

      progressDiv.style.display = 'block';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('progressText').textContent = 'D√©marrage de l\'import...';
      document.getElementById('photosScraped').textContent = '0';
      document.getElementById('photosTotal').textContent = photoCount;
      document.getElementById('timeElapsed').textContent = '0s';
      document.getElementById('speed').textContent = '0';
      
      importStartTime = Date.now();

      try {
        showToast(`D√©marrage de l'import ${category} - ${photoCount} photos`, 'info');
        addLog(`Import ${category}: ${photoCount} photos depuis Pinterest`);
        
        const response = await fetch(`${API_URL}/scrape`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pinterest_link: pinterestLink,
            category: category,
            photo_count: parseInt(photoCount)
          })
        });

        const data = await response.json();
        
        if (response.ok) {
          currentImportId = data.import_id;
          addLog(`Import d√©marr√© avec succ√®s - ID: ${data.import_id}`);
        } else {
          showToast(`Erreur: ${data.error}`, 'error');
          addLog(`Erreur lors de l'import: ${data.error}`, 'error');
          progressDiv.style.display = 'none';
        }
      } catch (error) {
        showToast(`Erreur de connexion: ${error.message}`, 'error');
        addLog(`Erreur de connexion: ${error.message}`, 'error');
        progressDiv.style.display = 'none';
      }
    });

    async function loadGallery() {
      const grid = document.getElementById('galleryGrid');
      const filter = document.getElementById('galleryFilter').value;
      
      grid.innerHTML = '<div class="spinner"></div>';
      
      try {
        const url = filter === 'all' 
          ? `${API_URL}/photos` 
          : `${API_URL}/photos?category=${filter}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.photos && data.photos.length > 0) {
          grid.innerHTML = data.photos.map(photo => `
            <div class="gallery-item">
              <img src="${photo.url}" alt="${photo.category}" loading="lazy">
            </div>
          `).join('');
        } else {
          grid.innerHTML = '<div class="gallery-empty">Aucune photo trouv√©e üì∑</div>';
        }
      } catch (error) {
        grid.innerHTML = '<div class="gallery-empty">Erreur de chargement ‚ùå</div>';
        showToast('Erreur lors du chargement de la galerie', 'error');
      }
    }

    async function loadHistory() {
      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem"><div class="spinner"></div></td></tr>';
      
      try {
        const response = await fetch(`${API_URL}/history`);
        const data = await response.json();
        
        if (data.history && data.history.length > 0) {
          tbody.innerHTML = data.history.map(item => {
            const date = new Date(item.date).toLocaleString('fr-FR');
            const statusClass = item.status === 'success' ? 'status-success' : 
                               item.status === 'error' ? 'status-error' : 'status-pending';
            const statusText = item.status === 'success' ? '‚úÖ Termin√©' : 
                              item.status === 'error' ? '‚ùå Erreur' : '‚è≥ En cours';
            
            return `
              <tr>
                <td>${date}</td>
                <td>${item.source || 'Pinterest'}</td>
                <td>${item.category}</td>
                <td>${item.photo_count}</td>
                <td>${item.duration || '-'}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
              </tr>
            `;
          }).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;opacity:0.6">Aucun historique üìã</td></tr>';
        }
      } catch (error) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:#ef4444">Erreur de chargement ‚ùå</td></tr>';
        showToast('Erreur lors du chargement de l\'historique', 'error');
      }
    }

    async function updateDashboard() {
      try {
        const response = await fetch(`${API_URL}/stats`);
        const data = await response.json();
        
        document.getElementById('totalPhotos').textContent = data.total_photos || 0;
        document.getElementById('totalImports').textContent = data.total_imports || 0;
        document.getElementById('todayPhotos').textContent = data.today_photos || 0;
        document.getElementById('lastActivity').textContent = data.last_activity || 'Jamais';
      } catch (error) {
        showToast('Erreur lors de la r√©cup√©ration des statistiques', 'error');
      }
    }

    function addLog(message, type = 'info') {
      const logContainer = document.getElementById('logContainer');
      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString('fr-FR');
      logEntry.textContent = `[${timestamp}] ${message}`;
      logContainer.insertBefore(logEntry, logContainer.firstChild);
      
      if (logContainer.children.length > 50) {
        logContainer.removeChild(logContainer.lastChild);
      }
    }

    document.getElementById('galleryFilter').addEventListener('change', loadGallery);
  </script>
</body>
</html>
